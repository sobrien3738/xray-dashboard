<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Ray & Compliance Tracking Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        .autocomplete-item:hover {
            background-color: #f3f4f6;
        }
        .toast {
            transition: all 0.3s ease-in-out;
            transform: translateX(100%);
        }
        .toast.show {
            transform: translateX(0);
        }
        .sync-indicator {
            transition: all 0.3s ease;
        }
        .sync-indicator.syncing {
            color: #f59e0b;
        }
        .sync-indicator.synced {
            color: #10b981;
        }
        .sync-indicator.error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="p-6 space-y-6 bg-gray-50 min-h-screen">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-semibold text-gray-900">X-Ray & Compliance Tracking</h1>
                <div class="flex items-center gap-4">
                    <div id="sync-status" class="flex items-center gap-2 text-sm">
                        <div id="sync-indicator" class="w-3 h-3 rounded-full bg-gray-300"></div>
                        <span id="sync-text">Connecting...</span>
                    </div>
                    <div id="loading-indicator" class="items-center gap-2 hidden">
                        <div class="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div id="stats-container">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-2xl font-bold text-gray-900" id="stat-total">0</div>
                        <div class="text-sm text-gray-600">Total Records</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-2xl font-bold text-yellow-600" id="stat-pending">0</div>
                        <div class="text-sm text-gray-600">Pending Testing</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-2xl font-bold text-green-600" id="stat-passed">0</div>
                        <div class="text-sm text-gray-600">Passed Testing</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-2xl font-bold text-green-600" id="stat-paid">0</div>
                        <div class="text-sm text-gray-600">Paid</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-2xl font-bold text-red-600" id="stat-unpaid">0</div>
                        <div class="text-sm text-gray-600">Unpaid</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Tabs">
                        <button id="invoicing-tab" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border-b-2 border-blue-600 rounded-t-md">
                            ðŸ’° Invoicing
                        </button>
                        <button id="testing-tab" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent rounded-t-md">
                            ðŸ§ª Testing
                        </button>
                    </nav>
                </div>

                <!-- Controls Section -->
                <div class="p-4 space-y-4">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <input
                            id="search"
                            type="text"
                            placeholder="Search by customer, METRC tag, or invoice..."
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <div class="flex gap-2">
                            <label class="flex items-center gap-2 cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Upload Excel
                                <input id="excel-upload" type="file" accept=".xlsx,.xls" class="hidden" />
                            </label>
                            <button id="export-btn" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                                Export Excel
                            </button>
                            <button id="add-record-btn" class="px-4 py-2 text-sm bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                Add Record
                            </button>
                            <button id="sync-btn" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                Force Sync
                            </button>
                            <button id="debug-btn" class="px-4 py-2 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                Debug
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="p-4 overflow-x-auto">
                    <div id="invoicing-table">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 font-medium text-gray-900">Date Created</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Customer</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Invoice To</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">METRC Tag</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Weight (Input)</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Invoice Weight</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Invoice #</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Payment Method</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Payment Details</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Paid Status</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Paid Date</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicing-tbody">
                                <tr class="border-b border-gray-100">
                                    <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                                        Loading data from cloud...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="testing-table" class="hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 font-medium text-gray-900">Date Created</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Customer</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">METRC Tag</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Weight (Input)</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Invoice Weight</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Tests Failed</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Lab</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Compliance Status</th>
                                    <th class="px-4 py-3 font-medium text-gray-900">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="testing-tbody">
                                <tr class="border-b border-gray-100">
                                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                        Loading data from cloud...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://njkudhzmqvxrkpxlnbii.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qa3VkaHptcXZ4cmtweGxuYmlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MjY2NzksImV4cCI6MjA2NjAwMjY3OX0.mca-MhlIPxsPNITxL6Dq23_U3oJMQGq_PJNemmF1r6c'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Global variables
        let dashboardData = []
        let currentTab = 'invoicing'
        let isOnline = navigator.onLine
        let syncQueue = []
        
        const dropdownOptions = {
            customers: ["Blue Sky Lab LLC", "Dreamscape Farms SP LLC", "The King's Stache LLC", "Flamingo Fine Cannabis LLC"],
            invoiceTo: ["Blue Sky", "Dreamscape Farms", "King's Stache", "Flamingo Fine Cannabis"],
            testsFailed: ["All Micros", "Total Yeast & Mold", "Mycotoxins", "None"],
            labs: ["CATLAB", "MCR", "Nelson", "Nova"]
        }

        // Column mapping for Excel import
        const COLUMN_MAPPING = {
            0: 'metrc_tag',          // Column A: METRC Tag
            1: 'invoice_to',         // Column B: Invoice To
            2: 'customer',           // Column C: Customer
            7: 'invoice_weight',     // Column H: Weight
            9: 'invoice_number',     // Column J: Invoice Number
            10: 'paid_date',         // Column K: Paid Date
            11: 'tests_failed',      // Column L: Tests Failed
            12: 'lab',               // Column M: Lab
            22: 'compliance_status'  // Column W: Compliance Status
        }

        // Supabase Functions
        async function initializeSupabase() {
            try {
                updateSyncStatus('connecting', 'Connecting to cloud...')
                
                // Test connection
                const { data, error } = await supabase.from('xray_records').select('count').limit(1)
                
                if (error) {
                    console.error('Supabase connection error:', error)
                    updateSyncStatus('error', 'Cloud connection failed')
                    return false
                }
                
                updateSyncStatus('synced', 'Connected to cloud')
                
                // Load existing data
                await loadDataFromSupabase()
                
                // Set up real-time subscription
                setupRealtimeSubscription()
                
                return true
            } catch (error) {
                console.error('Failed to initialize Supabase:', error)
                updateSyncStatus('error', 'Failed to connect')
                return false
            }
        }

        async function loadDataFromSupabase() {
            try {
                updateSyncStatus('syncing', 'Loading data...')
                
                const { data, error } = await supabase
                    .from('xray_records')
                    .select('*')
                    .order('created_at', { ascending: false })

                if (error) {
                    console.error('Error loading data:', error)
                    updateSyncStatus('error', 'Failed to load data')
                    showToast('Failed to load data from cloud', 'error')
                    return
                }

                if (data && data.length > 0) {
                    dashboardData = data.map(record => ({
                        id: record.id,
                        date_created: record.date_created || new Date().toISOString().split('T')[0],
                        customer: record.customer || '',
                        invoice_to: record.invoice_to || '',
                        metrc_tag: record.metrc_tag || '',
                        invoice_weight: record.invoice_weight || '',
                        weight_input_value: record.weight_input_value || record.invoice_weight || '',
                        weight_unit: record.weight_unit || 'lbs',
                        invoice_number: record.invoice_number || '',
                        payment_method: record.payment_method || '',
                        payment_details: record.payment_details || '',
                        paid_status: record.paid_status || 'Not Paid',
                        paid_date: record.paid_date || '',
                        tests_failed: record.tests_failed || '',
                        lab: record.lab || '',
                        compliance_status: record.compliance_status || 'Not Set'
                    }))
                    
                    console.log(`Loaded ${data.length} records from Supabase`)
                    updateSyncStatus('synced', `${data.length} records synced`)
                } else {
                    dashboardData = []
                    updateSyncStatus('synced', 'No records found')
                }

                updateTables()
                updateStats()
                
            } catch (error) {
                console.error('Error in loadDataFromSupabase:', error)
                updateSyncStatus('error', 'Sync failed')
                showToast('Error loading data from cloud', 'error')
            }
        }

        async function saveRecordToSupabase(record, isUpdate = false) {
            try {
                const recordData = {
                    id: record.id,
                    date_created: record.date_created,
                    customer: record.customer,
                    invoice_to: record.invoice_to,
                    metrc_tag: record.metrc_tag,
                    invoice_weight: record.invoice_weight,
                    weight_input_value: record.weight_input_value,
                    weight_unit: record.weight_unit,
                    invoice_number: record.invoice_number,
                    payment_method: record.payment_method,
                    payment_details: record.payment_details,
                    paid_status: record.paid_status,
                    paid_date: record.paid_date,
                    tests_failed: record.tests_failed,
                    lab: record.lab,
                    compliance_status: record.compliance_status,
                    updated_at: new Date().toISOString()
                }

                let result
                if (isUpdate) {
                    result = await supabase
                        .from('xray_records')
                        .update(recordData)
                        .eq('id', record.id)
                } else {
                    result = await supabase
                        .from('xray_records')
                        .insert([recordData])
                }

                if (result.error) {
                    console.error('Error saving to Supabase:', result.error)
                    addToSyncQueue(record, isUpdate ? 'update' : 'insert')
                    return false
                }

                console.log(`Record ${isUpdate ? 'updated' : 'saved'} to Supabase:`, record.id)
                updateSyncStatus('synced', 'Data synced')
                return true
                
            } catch (error) {
                console.error('Error in saveRecordToSupabase:', error)
                addToSyncQueue(record, isUpdate ? 'update' : 'insert')
                return false
            }
        }

        async function deleteRecordFromSupabase(recordId) {
            try {
                const { error } = await supabase
                    .from('xray_records')
                    .delete()
                    .eq('id', recordId)

                if (error) {
                    console.error('Error deleting from Supabase:', error)
                    addToSyncQueue({ id: recordId }, 'delete')
                    return false
                }

                console.log('Record deleted from Supabase:', recordId)
                updateSyncStatus('synced', 'Record deleted')
                return true
                
            } catch (error) {
                console.error('Error in deleteRecordFromSupabase:', error)
                addToSyncQueue({ id: recordId }, 'delete')
                return false
            }
        }

        function setupRealtimeSubscription() {
            const subscription = supabase
                .channel('xray_records_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'xray_records'
                }, (payload) => {
                    console.log('Real-time update received:', payload)
                    handleRealtimeChange(payload)
                })
                .subscribe()

            console.log('Real-time subscription established')
        }

        function handleRealtimeChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload

            switch (eventType) {
                case 'INSERT':
                    // Check if record already exists locally
                    const existingIndex = dashboardData.findIndex(r => r.id === newRecord.id)
                    if (existingIndex === -1) {
                        dashboardData.unshift(newRecord)
                        updateTables()
                        updateStats()
                        showToast('New record synced from cloud', 'info')
                    }
                    break
                    
                case 'UPDATE':
                    const updateIndex = dashboardData.findIndex(r => r.id === newRecord.id)
                    if (updateIndex !== -1) {
                        dashboardData[updateIndex] = { ...dashboardData[updateIndex], ...newRecord }
                        updateTables()
                        updateStats()
                        showToast('Record updated from cloud', 'info')
                    }
                    break
                    
                case 'DELETE':
                    const deleteIndex = dashboardData.findIndex(r => r.id === oldRecord.id)
                    if (deleteIndex !== -1) {
                        dashboardData.splice(deleteIndex, 1)
                        updateTables()
                        updateStats()
                        showToast('Record deleted from cloud', 'info')
                    }
                    break
            }
        }

        function addToSyncQueue(record, action) {
            syncQueue.push({ record, action, timestamp: Date.now() })
            updateSyncStatus('error', `${syncQueue.length} items pending sync`)
            console.log('Added to sync queue:', action, record.id || record)
        }

        async function processSyncQueue() {
            if (syncQueue.length === 0) return

            updateSyncStatus('syncing', 'Syncing pending changes...')
            
            const queue = [...syncQueue]
            syncQueue = []

            for (const item of queue) {
                try {
                    switch (item.action) {
                        case 'insert':
                            await saveRecordToSupabase(item.record, false)
                            break
                        case 'update':
                            await saveRecordToSupabase(item.record, true)
                            break
                        case 'delete':
                            await deleteRecordFromSupabase(item.record.id)
                            break
                    }
                } catch (error) {
                    console.error('Error processing sync queue item:', error)
                    syncQueue.push(item) // Re-add failed items
                }
            }

            if (syncQueue.length === 0) {
                updateSyncStatus('synced', 'All changes synced')
                showToast('All pending changes synced successfully', 'success')
            } else {
                updateSyncStatus('error', `${syncQueue.length} items failed to sync`)
            }
        }

        function updateSyncStatus(status, message) {
            const indicator = document.getElementById('sync-indicator')
            const text = document.getElementById('sync-text')
            
            indicator.className = `w-3 h-3 rounded-full ${
                status === 'syncing' ? 'bg-yellow-500 animate-pulse' :
                status === 'synced' ? 'bg-green-500' :
                status === 'error' ? 'bg-red-500' :
                'bg-gray-300'
            }`
            
            text.textContent = message
            text.className = `sync-indicator ${status}`
        }

        // Network status handling
        window.addEventListener('online', () => {
            isOnline = true
            updateSyncStatus('syncing', 'Back online, syncing...')
            processSyncQueue()
            loadDataFromSupabase()
        })

        window.addEventListener('offline', () => {
            isOnline = false
            updateSyncStatus('error', 'Offline - changes will sync when online')
        })

        // Convert weight to pounds based on unit
        function convertToPounds(value, unit) {
            if (!value || value === '') return ''
            const numValue = parseFloat(value)
            if (isNaN(numValue)) return ''
            
            if (unit === 'grams') {
                return (numValue / 453.59).toFixed(2)
            }
            return numValue.toFixed(2)
        }

        // Create weight input with unit selector
        function createWeightInput(record, context = '') {
            const weightValue = record.weight_input_value || record.invoice_weight || ''
            const weightUnit = record.weight_unit || 'lbs'
            const inputId = `weight-${context}${record.id}`
            
            return `
                <div class="flex items-center gap-1">
                    <input type="number" 
                           id="${inputId}"
                           step="0.01" 
                           value="${weightValue}" 
                           onchange="updateWeight(${record.id}, this.value, document.getElementById('${inputId}-unit').value)"
                           class="px-3 py-2 border border-gray-300 rounded-md text-sm w-20 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <select id="${inputId}-unit" 
                            onchange="updateWeight(${record.id}, document.getElementById('${inputId}').value, this.value)"
                            class="px-2 py-2 border border-gray-300 rounded-md text-xs w-16 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="lbs" ${weightUnit === 'lbs' ? 'selected' : ''}>lbs</option>
                        <option value="grams" ${weightUnit === 'grams' ? 'selected' : ''}>g</option>
                    </select>
                </div>
            `
        }

        // Update weight with conversion
        async function updateWeight(recordId, inputValue, unit) {
            const record = dashboardData.find(r => r.id == recordId)
            if (record) {
                // Store the original input value and unit
                record.weight_input_value = inputValue
                record.weight_unit = unit
                
                // Convert to pounds for storage
                record.invoice_weight = convertToPounds(inputValue, unit)
                
                // Save to Supabase
                await saveRecordToSupabase(record, true)
                
                updateTables()
                updateStats()
                
                // Show conversion notification
                if (inputValue && unit === 'grams') {
                    showToast(`${inputValue}g converted to ${record.invoice_weight} lbs`, 'info')
                }
                
                console.log(`Weight updated: ${inputValue} ${unit} = ${record.invoice_weight} lbs`)
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div')
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            
            toast.className = `toast ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">Ã—</button>
                </div>
            `
            
            const container = document.getElementById('toast-container')
            container.appendChild(toast)
            setTimeout(() => toast.classList.add('show'), 100)
            setTimeout(() => {
                toast.classList.remove('show')
                setTimeout(() => toast.remove(), 300)
            }, 5000)
        }

        // Handle Excel file upload
        async function handleExcelUpload(event) {
            const file = event.target.files[0]
            if (!file) {
                console.log('No file selected')
                return
            }

            console.log('Processing file:', file.name)
            showToast('Processing Excel file...', 'info')
            
            const reader = new FileReader()
            reader.onload = async function(e) {
                try {
                    console.log('File read successfully, parsing Excel...')
                    const data = new Uint8Array(e.target.result)
                    const workbook = XLSX.read(data, { type: 'array' })
                    
                    console.log('Available sheets:', workbook.SheetNames)
                    
                    let sheetName = workbook.SheetNames[0]
                    const worksheet = workbook.Sheets[sheetName]
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        raw: false 
                    })

                    console.log('Parsed data:', jsonData.length, 'rows')
                    console.log('First few rows:', jsonData.slice(0, 3))
                    
                    let newRecordsCount = 0
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i]
                        
                        if (!row || !row[0] || row[0].toString().trim() === '') {
                            continue
                        }
                        
                        const newRecord = {
                            id: Date.now() + i,
                            date_created: new Date().toISOString().split('T')[0]
                        }
                        
                        // Map Excel columns to record fields
                        Object.keys(COLUMN_MAPPING).forEach(colIndex => {
                            const fieldName = COLUMN_MAPPING[colIndex]
                            const cellValue = row[parseInt(colIndex)]
                            
                            if (cellValue && cellValue.toString().trim()) {
                                newRecord[fieldName] = cellValue.toString().trim()
                            }
                        })
                        
                        // Set defaults
                        newRecord.customer = newRecord.customer || ''
                        newRecord.invoice_weight = newRecord.invoice_weight || ''
                        newRecord.weight_unit = 'lbs'
                        newRecord.weight_input_value = newRecord.invoice_weight
                        newRecord.invoice_number = newRecord.invoice_number || ''
                        newRecord.payment_method = newRecord.payment_method || ''
                        newRecord.payment_details = newRecord.payment_details || ''
                        newRecord.tests_failed = newRecord.tests_failed || ''
                        newRecord.lab = newRecord.lab || ''
                        newRecord.compliance_status = newRecord.compliance_status || 'Not Set'
                        newRecord.paid_status = newRecord.paid_date ? 'Paid' : 'Not Paid'
                        
                        dashboardData.push(newRecord)
                        
                        // Save to Supabase
                        await saveRecordToSupabase(newRecord, false)
                        
                        newRecordsCount++
                        
                        console.log(`Added record ${i}:`, newRecord.customer, newRecord.metrc_tag)
                    }

                    console.log(`Import complete: ${newRecordsCount} new records added`)
                    
                    updateTables()
                    updateStats()
                    
                    showToast(`Excel import complete! ${newRecordsCount} records added and synced to cloud.`, 'success')
                    event.target.value = ''
                    
                } catch (error) {
                    console.error('Error processing Excel file:', error)
                    showToast('Error processing Excel file: ' + error.message, 'error')
                }
            }
            
            reader.onerror = function(error) {
                console.error('Error reading file:', error)
                showToast('Error reading file', 'error')
            }
            
            reader.readAsArrayBuffer(file)
        }

        // Update both tables
        function updateTables() {
            updateInvoicingTable()
            updateTestingTable()
        }

        // Update invoicing table
        function updateInvoicingTable() {
            const tbody = document.getElementById('invoicing-tbody')
            if (dashboardData.length === 0) {
                tbody.innerHTML = `
                    <tr class="border-b border-gray-100">
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            Upload an Excel file or add records to get started
                        </td>
                    </tr>
                `
                return
            }

            tbody.innerHTML = dashboardData.map(record => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900 text-xs">${record.date_created}</td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.customer}" 
                            onchange="updateRecordField(${record.id}, 'customer', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.invoice_to}" 
                            onchange="updateRecordField(${record.id}, 'invoice_to', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.metrc_tag}" 
                            onchange="updateRecordField(${record.id}, 'metrc_tag', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[160px] focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono" />
                    </td>
                    <td class="px-4 py-3">
                        ${createWeightInput(record, 'inv-')}
                    </td>
                    <td class="px-4 py-3">
                        <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-md text-sm text-gray-700 font-medium">
                            ${parseFloat(record.invoice_weight || 0).toFixed(2)} lbs
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.invoice_number}" 
                            onchange="updateRecordField(${record.id}, 'invoice_number', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[120px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="updateRecordField(${record.id}, 'payment_method', this.value)" 
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[100px] focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" ${!record.payment_method ? 'selected' : ''}>Select Method</option>
                            <option value="Check" ${record.payment_method === 'Check' ? 'selected' : ''}>Check</option>
                            <option value="Cash" ${record.payment_method === 'Cash' ? 'selected' : ''}>Cash</option>
                            <option value="ACH" ${record.payment_method === 'ACH' ? 'selected' : ''}>ACH</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.payment_details || ''}" 
                            placeholder="${record.payment_method === 'Check' ? 'Check #' : record.payment_method === 'Cash' ? 'Amount/Notes' : record.payment_method === 'ACH' ? 'Reference #' : 'Details'}"
                            onchange="updateRecordField(${record.id}, 'payment_details', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[120px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="updateRecordField(${record.id}, 'paid_status', this.value)" 
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[100px] focus:outline-none focus:ring-2 focus:ring-blue-500 ${record.paid_status === 'Paid' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                            <option value="Not Paid" ${record.paid_status === 'Not Paid' ? 'selected' : ''}>Not Paid</option>
                            <option value="Paid" ${record.paid_status === 'Paid' ? 'selected' : ''}>Paid</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <input type="date" value="${record.paid_date || ''}" 
                            onchange="updateRecordField(${record.id}, 'paid_date', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="deleteRecord(${record.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('')
        }

        // Update testing table
        function updateTestingTable() {
            const tbody = document.getElementById('testing-tbody')
            if (dashboardData.length === 0) {
                tbody.innerHTML = `
                    <tr class="border-b border-gray-100">
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            Upload an Excel file or add records to get started
                        </td>
                    </tr>
                `
                return
            }

            tbody.innerHTML = dashboardData.map(record => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-gray-900 text-xs">${record.date_created}</td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.customer}" 
                            onchange="updateRecordField(${record.id}, 'customer', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.metrc_tag}" 
                            onchange="updateRecordField(${record.id}, 'metrc_tag', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[160px] focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono" />
                    </td>
                    <td class="px-4 py-3">
                        ${createWeightInput(record, 'test-')}
                    </td>
                    <td class="px-4 py-3">
                        <div class="px-3 py-2 bg-gray-50 border border-gray-200 rounded-md text-sm text-gray-700 font-medium">
                            ${parseFloat(record.invoice_weight || 0).toFixed(2)} lbs
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.tests_failed}" 
                            onchange="updateRecordField(${record.id}, 'tests_failed', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[140px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" value="${record.lab}" 
                            onchange="updateRecordField(${record.id}, 'lab', this.value)"
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[100px] focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="updateRecordField(${record.id}, 'compliance_status', this.value)" 
                            class="px-3 py-2 border border-gray-300 rounded-md text-sm w-full min-w-[120px] focus:outline-none focus:ring-2 focus:ring-blue-500 ${record.compliance_status?.includes('Passed') ? 'bg-green-50 text-green-800' : record.compliance_status?.includes('Failed') ? 'bg-red-50 text-red-800' : 'bg-white'}">
                            <option value="Not Set" ${record.compliance_status === 'Not Set' ? 'selected' : ''}>Not Set</option>
                            <option value="Passed Testing" ${record.compliance_status === 'Passed Testing' ? 'selected' : ''}>Passed Testing</option>
                            <option value="Failed Testing" ${record.compliance_status === 'Failed Testing' ? 'selected' : ''}>Failed Testing</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="deleteRecord(${record.id})" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('')
        }

        // Update individual record field
        async function updateRecordField(recordId, fieldName, value) {
            const record = dashboardData.find(r => r.id == recordId)
            if (record) {
                record[fieldName] = value
                
                if (fieldName === 'paid_date') {
                    record.paid_status = value ? 'Paid' : 'Not Paid'
                }
                
                // Save to Supabase
                await saveRecordToSupabase(record, true)
                
                // Update both tables when any field changes to keep them in sync
                updateTables()
                updateStats()
                
                // Show a subtle indication that data synced between tabs
                if (fieldName === 'customer' || fieldName === 'metrc_tag' || fieldName === 'invoice_weight') {
                    console.log(`Updated ${fieldName} for record ${recordId} - synced across both tabs and cloud`)
                }
            }
        }

        // Delete record
        async function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this record? This will also remove it from the cloud.')) {
                // Remove from local data
                dashboardData = dashboardData.filter(r => r.id != recordId)
                
                // Delete from Supabase
                await deleteRecordFromSupabase(recordId)
                
                updateTables()
                updateStats()
                showToast('Record deleted successfully', 'success')
            }
        }

        // Update statistics
        function updateStats() {
            const total = dashboardData.length
            const paid = dashboardData.filter(r => r.paid_status === 'Paid').length
            const unpaid = dashboardData.filter(r => r.paid_status === 'Not Paid').length
            const passed = dashboardData.filter(r => r.compliance_status?.includes('Passed')).length
            const pending = dashboardData.filter(r => r.compliance_status === 'Not Set' || !r.compliance_status).length

            document.getElementById('stat-total').textContent = total
            document.getElementById('stat-pending').textContent = pending
            document.getElementById('stat-passed').textContent = passed
            document.getElementById('stat-paid').textContent = paid
            document.getElementById('stat-unpaid').textContent = unpaid
        }

        // Switch between tabs
        function switchToTab(tab) {
            const invoicingBtn = document.getElementById('invoicing-tab')
            const testingBtn = document.getElementById('testing-tab')
            const invoicingTable = document.getElementById('invoicing-table')
            const testingTable = document.getElementById('testing-table')

            currentTab = tab

            if (tab === 'testing') {
                // Update button styles
                testingBtn.className = 'px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border-b-2 border-blue-600 rounded-t-md'
                invoicingBtn.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent rounded-t-md'
                
                // Show/hide tables
                testingTable.classList.remove('hidden')
                invoicingTable.classList.add('hidden')
                
                // Refresh testing table to show latest data from invoicing tab
                updateTestingTable()
                
                console.log('Switched to Testing tab - data synced from Invoicing')
            } else {
                // Update button styles
                invoicingBtn.className = 'px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border-b-2 border-blue-600 rounded-t-md'
                testingBtn.className = 'px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent rounded-t-md'
                
                // Show/hide tables
                invoicingTable.classList.remove('hidden')
                testingTable.classList.add('hidden')
                
                // Refresh invoicing table to show latest data from testing tab
                updateInvoicingTable()
                
                console.log('Switched to Invoicing tab - data synced from Testing')
            }
        }

        // Export to Excel
        function exportToExcel() {
            try {
                const exportData = dashboardData.map(record => ({
                    'Date Created': record.date_created,
                    'Customer': record.customer,
                    'Invoice To': record.invoice_to,
                    'METRC Tag': record.metrc_tag,
                    'Invoice Weight (lbs)': record.invoice_weight,
                    'Weight Input': `${record.weight_input_value || record.invoice_weight} ${record.weight_unit || 'lbs'}`,
                    'Invoice #': record.invoice_number,
                    'Payment Method': record.payment_method,
                    'Payment Details': record.payment_details,
                    'Paid Status': record.paid_status,
                    'Paid Date': record.paid_date,
                    'Tests Failed': record.tests_failed,
                    'Lab': record.lab,
                    'Compliance Status': record.compliance_status
                }))

                const ws = XLSX.utils.json_to_sheet(exportData)
                const wb = XLSX.utils.book_new()
                XLSX.utils.book_append_sheet(wb, ws, "X-Ray Tracking")
                XLSX.writeFile(wb, `xray-tracking-${new Date().toISOString().split('T')[0]}.xlsx`)
                showToast('Data exported successfully', 'success')
            } catch (error) {
                console.error('Error exporting data:', error)
                showToast('Error exporting data', 'error')
            }
        }

        // Force sync function
        async function forceSync() {
            updateSyncStatus('syncing', 'Force syncing...')
            try {
                await loadDataFromSupabase()
                await processSyncQueue()
                showToast('Force sync completed', 'success')
            } catch (error) {
                console.error('Force sync error:', error)
                showToast('Force sync failed', 'error')
                updateSyncStatus('error', 'Sync failed')
            }
        }

        // Show debug info
        function showDebugInfo() {
            console.log('Dashboard Data:', dashboardData)
            console.log('Total Records:', dashboardData.length)
            console.log('Current Tab:', currentTab)
            console.log('Sync Queue:', syncQueue)
            console.log('Online Status:', isOnline)
            
            // Log element presence
            console.log('Elements found:', {
                invoicingTab: !!document.getElementById('invoicing-tab'),
                testingTab: !!document.getElementById('testing-tab'),
                excelUpload: !!document.getElementById('excel-upload'),
                invoicingTable: !!document.getElementById('invoicing-table'),
                testingTable: !!document.getElementById('testing-table')
            })
            
            let info = `Total Records: ${dashboardData.length}\nCurrent Tab: ${currentTab}\nOnline: ${isOnline}\nSync Queue: ${syncQueue.length} items\n\n`
            
            if (dashboardData.length > 0) {
                info += 'First few records:\n'
                dashboardData.slice(0, 3).forEach((record, index) => {
                    info += `\nRecord ${index + 1}:\n`
                    info += `- Customer: ${record.customer}\n`
                    info += `- METRC Tag: ${record.metrc_tag}\n`
                    info += `- Invoice #: ${record.invoice_number}\n`
                })
            } else {
                info += 'No records found. Try uploading an Excel file or adding records manually.'
            }
            
            alert(info + '\n\nCheck console for detailed data including Supabase connection status')
        }

        // Add new record modal
        function showAddRecordModal() {
            const modal = document.createElement('div')
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-gray-900">Add New Record</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form id="add-record-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
                                    <input type="text" name="customer" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice To</label>
                                    <input type="text" name="invoice_to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">METRC Tag</label>
                                    <input type="text" name="metrc_tag" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Weight</label>
                                    <div class="flex gap-2">
                                        <input type="number" step="0.01" name="invoice_weight" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        <select name="weight_unit" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="lbs">lbs</option>
                                            <option value="grams">g</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                                    <input type="text" name="invoice_number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                                    <select name="payment_method" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Method</option>
                                        <option value="Check">Check</option>
                                        <option value="Cash">Cash</option>
                                        <option value="ACH">ACH</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Details</label>
                                    <input type="text" name="payment_details" placeholder="Check #, Amount, Reference #, etc." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lab</label>
                                    <input type="text" name="lab" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tests Failed</label>
                                <input type="text" name="tests_failed" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            
                            <div class="flex justify-end gap-3 pt-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                                    Cancel
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Add Record
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `
            
            document.body.appendChild(modal)
            
            // Add form handler
            document.getElementById('add-record-form').addEventListener('submit', async (e) => {
                e.preventDefault()
                const formData = new FormData(e.target)
                
                const weightValue = formData.get('invoice_weight') || ''
                const weightUnit = formData.get('weight_unit') || 'lbs'
                
                const newRecord = {
                    id: Date.now(),
                    customer: formData.get('customer') || '',
                    invoice_to: formData.get('invoice_to') || '',
                    metrc_tag: formData.get('metrc_tag') || '',
                    invoice_weight: convertToPounds(weightValue, weightUnit),
                    weight_input_value: weightValue,
                    weight_unit: weightUnit,
                    invoice_number: formData.get('invoice_number') || '',
                    payment_method: formData.get('payment_method') || '',
                    payment_details: formData.get('payment_details') || '',
                    lab: formData.get('lab') || '',
                    tests_failed: formData.get('tests_failed') || '',
                    date_created: new Date().toISOString().split('T')[0],
                    paid_status: 'Not Paid',
                    paid_date: '',
                    compliance_status: 'Not Set'
                }
                
                dashboardData.unshift(newRecord)
                
                // Save to Supabase
                await saveRecordToSupabase(newRecord, false)
                
                updateTables()
                updateStats()
                modal.remove()
                
                // Show conversion message if needed
                if (weightValue && weightUnit === 'grams') {
                    showToast(`Record added and synced to cloud! ${weightValue}g converted to ${newRecord.invoice_weight} lbs`, 'success')
                } else {
                    showToast(`Record added successfully and synced to cloud! Available in both Invoicing and Testing tabs.`, 'success')
                }
            })
        }

        // Initialize the application
        async function init() {
            console.log('Initializing X-Ray Dashboard with Supabase...')
            
            // Initialize stats
            updateStats()
            
            console.log('Dashboard initialized successfully with Supabase integration!')
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            init()
        })
    </script>
</body>
</html> Supabase connection
            const supabaseConnected = await initializeSupabase()
            
            if (!supabaseConnected) {
                console.warn('Supabase connection failed - running in offline mode')
                showToast('Running in offline mode - changes will sync when connection is restored', 'info')
            }
            
            // Event listeners
            const excelUpload = document.getElementById('excel-upload')
            if (excelUpload) {
                excelUpload.addEventListener('change', handleExcelUpload)
                console.log('Excel upload listener added')
            }
            
            const exportBtn = document.getElementById('export-btn')
            if (exportBtn) {
                exportBtn.addEventListener('click', exportToExcel)
            }
            
            const addRecordBtn = document.getElementById('add-record-btn')
            if (addRecordBtn) {
                addRecordBtn.addEventListener('click', showAddRecordModal)
            }
            
            const syncBtn = document.getElementById('sync-btn')
            if (syncBtn) {
                syncBtn.addEventListener('click', forceSync)
            }
            
            const debugBtn = document.getElementById('debug-btn')
            if (debugBtn) {
                debugBtn.addEventListener('click', showDebugInfo)
            }
            
            // Tab switching
            const invoicingTab = document.getElementById('invoicing-tab')
            if (invoicingTab) {
                invoicingTab.addEventListener('click', (e) => {
                    e.preventDefault()
                    console.log('Invoicing tab clicked')
                    switchToTab('invoicing')
                })
            }
            
            const testingTab = document.getElementById('testing-tab')
            if (testingTab) {
                testingTab.addEventListener('click', (e) => {
                    e.preventDefault()
                    console.log('Testing tab clicked')
                    switchToTab('testing')
                })
            }

            // Initialize_to = newRecord.invoice_to || ''
                        newRecord.metrc_tag = newRecord.metrc_tag || ''
                        newRecord.invoice